message(STATUS "BUILD TRANSPORT LIBRARY WITH LIBRARY FILE")

# æ ¹æ®å¹³å°å’Œæ¶æ„è®¾ç½®åº“åç§°åç¼€
if(WIN32)
    set(TRANSPORT_ARCH_SUFFIX "")
elseif(APPLE)
    if(CMAKE_SYSTEM_PROCESSOR MATCHES "arm64|aarch64")
        set(TRANSPORT_ARCH_SUFFIX "_arm64")
    else()
        set(TRANSPORT_ARCH_SUFFIX "")
    endif()
elseif(UNIX AND NOT APPLE)
    if(CMAKE_SYSTEM_PROCESSOR MATCHES "arm64|aarch64")
        set(TRANSPORT_ARCH_SUFFIX "_arm64")
    else()
        set(TRANSPORT_ARCH_SUFFIX "")
    endif()
endif()

add_library(TransportDLL SHARED IMPORTED GLOBAL)

if(WIN32)
    # do nothing
elseif(APPLE)
    set(TRANSPORT_LIB_FILENAME "libtransport${TRANSPORT_ARCH_SUFFIX}.dylib")
elseif(UNIX AND NOT APPLE)
    set(TRANSPORT_LIB_FILENAME "libtransport${TRANSPORT_ARCH_SUFFIX}.so")
endif()

if(WIN32)
    set_target_properties(TransportDLL PROPERTIES
        IMPORTED_IMPLIB_DEBUG "${CMAKE_CURRENT_LIST_DIR}/transport${TRANSPORT_ARCH_SUFFIX}.lib"
        IMPORTED_LOCATION_DEBUG "${CMAKE_CURRENT_LIST_DIR}/transport${TRANSPORT_ARCH_SUFFIX}.dll"
        IMPORTED_IMPLIB_RELEASE "${CMAKE_CURRENT_LIST_DIR}/transport${TRANSPORT_ARCH_SUFFIX}.lib"
        IMPORTED_LOCATION_RELEASE "${CMAKE_CURRENT_LIST_DIR}/transport${TRANSPORT_ARCH_SUFFIX}.dll"
        INTERFACE_INCLUDE_DIRECTORIES "${CMAKE_CURRENT_LIST_DIR}"
    )
    # æ‹·è´å·²ç¼–è¯‘çš„ transport åŠ¨æ€åº“åˆ°è¿è¡Œç›®å½•ï¼ˆæ”¯æŒåˆ†ç¦»çš„ Debug/Release ç›®å½•ï¼‰
    # Debug é…ç½® - ä½¿ç”¨ release ç‰ˆæœ¬çš„åº“
    add_custom_target(copy_transport_dll_debug
        COMMAND ${CMAKE_COMMAND} -E make_directory "${CMAKE_CURRENT_SOURCE_DIR}/../../../bin/Debug"
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
        "${CMAKE_CURRENT_LIST_DIR}/transport${TRANSPORT_ARCH_SUFFIX}.dll"
        "${CMAKE_CURRENT_SOURCE_DIR}/../../../bin/Debug/transport${TRANSPORT_ARCH_SUFFIX}.dll"
        COMMENT "ğŸ“¦ Copying prebuilt transport${TRANSPORT_ARCH_SUFFIX}.dll to bin/Debug"
    )
    # Release é…ç½®
    add_custom_target(copy_transport_dll_release
        COMMAND ${CMAKE_COMMAND} -E make_directory "${CMAKE_CURRENT_SOURCE_DIR}/../../../bin/Release"
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
        "${CMAKE_CURRENT_LIST_DIR}/transport${TRANSPORT_ARCH_SUFFIX}.dll"
        "${CMAKE_CURRENT_SOURCE_DIR}/../../../bin/Release/transport${TRANSPORT_ARCH_SUFFIX}.dll"
        COMMENT "ğŸ“¦ Copying prebuilt transport${TRANSPORT_ARCH_SUFFIX}.dll to bin/Release"
    )
else()
    set_target_properties(TransportDLL PROPERTIES
        IMPORTED_LOCATION "${CMAKE_CURRENT_LIST_DIR}/${TRANSPORT_LIB_FILENAME}"
        INTERFACE_INCLUDE_DIRECTORIES "${CMAKE_CURRENT_LIST_DIR}"
    )
    # æ‹·è´å·²ç¼–è¯‘çš„ transport åŠ¨æ€åº“åˆ°è¿è¡Œç›®å½•
    # è®¾ç½®ç›®æ ‡è·¯å¾„
    set(TRANSPORT_LIB_PATH "${CMAKE_CURRENT_LIST_DIR}/${TRANSPORT_LIB_FILENAME}")
    set(TRANSPORT_LIB_DEST "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/${TRANSPORT_LIB_FILENAME}")
    # åªæœ‰å½“ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨æ—¶ï¼Œæ‰æ·»åŠ  copy ä»»åŠ¡
    if(NOT EXISTS "${TRANSPORT_LIB_DEST}")
        add_custom_target(copy_transport_dll ALL
            COMMAND ${CMAKE_COMMAND} -E copy_if_different
            "${TRANSPORT_LIB_PATH}"
            "${TRANSPORT_LIB_DEST}"
            COMMENT "ğŸ“¦ Copying prebuilt ${TRANSPORT_LIB_FILENAME} to ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}"
        )
    else()
        message(STATUS "âœ… Skipped copy: ${TRANSPORT_LIB_FILENAME} already exists in ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}")
    endif()
endif()
