cmake_minimum_required(VERSION 3.16)
project(HIDProject)

# ä¸º MSVC è®¾ç½®è¿è¡Œæ—¶åº“ - å¿…é¡»åœ¨ project() ä¹‹åç«‹å³è®¾ç½®
if(MSVC)
    # å¯ç”¨æ–°çš„ MSVC è¿è¡Œæ—¶åº“ç­–ç•¥
    cmake_policy(SET CMP0091 NEW)
    set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>DLL")

    # å¼ºåˆ¶ç§»é™¤é»˜è®¤çš„ /MDd å’Œ /MTd æ ‡å¿—ï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„è¿è¡Œæ—¶åº“
    foreach(flag_var
        CMAKE_CXX_FLAGS CMAKE_CXX_FLAGS_DEBUG CMAKE_CXX_FLAGS_RELEASE
        CMAKE_CXX_FLAGS_MINSIZEREL CMAKE_CXX_FLAGS_RELWITHDEBINFO)
        string(REPLACE "/MDd" "" ${flag_var} "${${flag_var}}")
        string(REPLACE "/MTd" "" ${flag_var} "${${flag_var}}")
        string(REPLACE "/MD" "" ${flag_var} "${${flag_var}}")
        string(REPLACE "/MT" "" ${flag_var} "${${flag_var}}")
    endforeach()

    # ä¸ºä¸åŒé…ç½®æ˜¾å¼è®¾ç½®è¿è¡Œæ—¶åº“
    set(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG} /MDd")
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} /MD")
    set(CMAKE_CXX_FLAGS_RELWITHDEBINFO "${CMAKE_CXX_FLAGS_RELWITHDEBINFO} /MD")
    set(CMAKE_CXX_FLAGS_MINSIZEREL "${CMAKE_CXX_FLAGS_MINSIZEREL} /MD")
endif()

set(TARGETNAME "main")

# æ·»åŠ æ„å»ºé€‰é¡¹
option(BUILD_LIBHIDCPP_SHARED "Build shared libhidcpp libraries" ON)
option(USE_SHARED_HIDAPI "Link with shared hidapi" ON)

# å¯æ‰§è¡Œç¨‹åºç”Ÿæˆè·¯å¾„ - åˆ†ç¦» Debug å’Œ Release
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY_DEBUG ${CMAKE_CURRENT_SOURCE_DIR}/bin/Debug)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY_RELEASE ${CMAKE_CURRENT_SOURCE_DIR}/bin/Release)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY_RELWITHDEBINFO ${CMAKE_CURRENT_SOURCE_DIR}/bin/RelWithDebInfo)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY_MINSIZEREL ${CMAKE_CURRENT_SOURCE_DIR}/bin/MinSizeRel)

# åº“æ–‡ä»¶è¾“å‡ºè·¯å¾„ - åˆ†ç¦» Debug å’Œ Release
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY_DEBUG ${CMAKE_CURRENT_SOURCE_DIR}/lib/Debug)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY_RELEASE ${CMAKE_CURRENT_SOURCE_DIR}/lib/Release)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY_DEBUG ${CMAKE_CURRENT_SOURCE_DIR}/lib/Debug)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY_RELEASE ${CMAKE_CURRENT_SOURCE_DIR}/lib/Release)

# å¼•å…¥ hidapi
include(cmake/FetchHid.cmake)
add_subdirectory(ImgProcesser)
add_subdirectory(src/Transport)

# æ”¶é›† Hotspot è®¾å¤‡ä¿¡æ¯
file(GLOB_RECURSE HOTSPOTDEVICE
    "${CMAKE_CURRENT_SOURCE_DIR}/src/HotspotDevice/**/*.cpp"
    "${CMAKE_CURRENT_SOURCE_DIR}/src/HotspotDevice/**/*.h"
)

# å¯æ‰§è¡Œç¨‹åº
add_executable(${TARGETNAME}
    src/main.cpp
    ${HOTSPOTDEVICE}
    "src/DeviceInfo/streamdockinfo.h"
    "src/DeviceInfo/streamdock.h"
    "src/DeviceInfo/streamdock.cpp"
    "src/DeviceInfo/streamdockfactory.h"
    "src/DeviceInfo/streamdockfactory.cpp"
    "src/DeviceInfo/featureoption.h"
    "src/DeviceInfo/Feature/RGBController/rgbcontroller.cpp"
    "src/DeviceInfo/Feature/GifController/gifcontroller.cpp"
    "src/DeviceInfo/Feature/ReadController/readcontroller.cpp"
    "src/DeviceInfo/Feature/Configer/configer.cpp"
    "src/DeviceInfo/Feature/HeartBeat/heartbeat.cpp"
    "src/DeviceManager/DeviceEnumerator/deviceenumerator.h"
    "src/DeviceManager/DeviceEnumerator/deviceenumerator.cpp"
    "src/DeviceManager/devicemanager.cpp" "src/DeviceManager/devicemanager_win.cpp"
    "src/DeviceManager/devicemanager.cpp" "src/DeviceManager/devicemanager_linux.cpp"
    "src/DeviceManager/devicemanager.cpp" "src/DeviceManager/devicemanager_mac.cpp"
    "src/ToolKit/toolkit.h"
)

# é“¾æ¥ 
target_link_libraries(${TARGETNAME} PRIVATE TransportCWrapper ImgProcesser) # ä¾èµ–åº“
target_include_directories(${TARGETNAME} # ä¾èµ–å¤´æ–‡ä»¶
    PRIVATE
    "src"
    "src/DeviceEnumerator"
    "src/DeviceInfo"
    "src/Transport"
    "src/ToolKit"
)
target_compile_features(${TARGETNAME} PRIVATE cxx_std_17)

# Windows ä¸‹ç¡®ä¿ Transport DLL è¢«å¤åˆ¶
if(WIN32)
    # æ·»åŠ å¯¹ Transport DLL å¤åˆ¶ç›®æ ‡çš„ä¾èµ–
    if(TARGET copy_transport_dll_debug)
        add_dependencies(${TARGETNAME} copy_transport_dll_debug)
    endif()
    if(TARGET copy_transport_dll_release)
        add_dependencies(${TARGETNAME} copy_transport_dll_release)
    endif()
endif()

# é¢å¤–é“¾æ¥
if(WIN32)
    target_link_libraries(${TARGETNAME} PRIVATE setupapi) # windows é¢å¤–éœ€è¦ä½¿ç”¨setupapi
elseif(APPLE)
    find_library(COREFOUNDATION_FRAMEWORK CoreFoundation)
    find_library(IOKIT_FRAMEWORK IOKit)
    find_library(APPLICATIONSERVICES_FRAMEWORK ApplicationServices)

    target_link_libraries(${TARGETNAME}
        PRIVATE
        ${COREFOUNDATION_FRAMEWORK}
        ${IOKIT_FRAMEWORK}
        ${APPLICATIONSERVICES_FRAMEWORK}
    )
elseif(UNIX AND NOT APPLE)
    target_link_libraries(${TARGETNAME}
        PRIVATE
        udev
        pthread
    )
endif()

# Windowsä¸‹å¤åˆ¶éœ€è¦çš„DLLåˆ°å¯æ‰§è¡Œæ–‡ä»¶ç›®å½•
if(WIN32)
    set(OpenCV_BIN_PATH "${CMAKE_CURRENT_SOURCE_DIR}/ImgProcesser/third_party/opencv/windows/x64/vc17/bin")

    # å®šä¹‰éœ€è¦å¤åˆ¶çš„ OpenCV DLL æ–‡ä»¶ï¼ˆä¸å¸¦åç¼€ï¼‰
    set(OpenCV_DLL_NAMES
        "opencv_core4120"
        "opencv_imgcodecs4120"
        "opencv_imgproc4120"
    )

    # ä¸ºæ¯ä¸ª OpenCV DLL åˆ›å»ºå¤åˆ¶å‘½ä»¤
    foreach(dll_name ${OpenCV_DLL_NAMES})
        add_custom_command(TARGET ${TARGETNAME} POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy_if_different
            "${OpenCV_BIN_PATH}/${dll_name}$<$<CONFIG:Debug>:d>.dll"
            "$<TARGET_FILE_DIR:${TARGETNAME}>/${dll_name}$<$<CONFIG:Debug>:d>.dll"
            COMMENT "ğŸ“¦ Copying ${dll_name}$<$<CONFIG:Debug>:d>.dll to output directory"
        )
    endforeach()
endif()
